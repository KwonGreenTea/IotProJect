<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Market Home</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì»¤ìŠ¤í…€ í…Œë§ˆ (ê¸°ì¡´ê³¼ ë™ì¼) */
        :root {
            --xmas-red: #D42426;
            --xmas-dark: #1A1A1A;
            --xmas-bg: #F8F9FA;
        }

        body {
            background-color: var(--xmas-bg);
            color: var(--xmas-dark);
            padding-bottom: 80px; /* ëª¨ë°”ì¼ í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ê³µê°„ í™•ë³´ */
        }

        .navbar-custom { background-color: var(--xmas-red); }
        .navbar-brand, .nav-link { color: white !important; font-weight: 600; }

        .product-card {
            border: 1p	x solid #ddd;
            transition: transform 0.2s;
            background: white;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: var(--xmas-red);
        }

        .spec-badge {
            font-size: 0.75rem;
            background-color: #f1f1f1;
            color: #555;
            padding: 4px 8px;
            border-radius: 4px;
            margin-right: 4px;
            margin-bottom: 4px;
            display: inline-block;
        }

        .mobile-bottom-nav {
            background-color: white;
            border-top: 1px solid #eee;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .mobile-nav-item {
            color: var(--xmas-dark);
            text-decoration: none;
            font-size: 0.8rem;
        }
        .mobile-nav-item.active { color: var(--xmas-red); }
        
        .price-tag {
            color: var(--xmas-red);
            font-weight: bold;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-custom sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fa-solid fa-snowflake me-2"></i>MERRY SHOP</a>
            
            <div class="collapse navbar-collapse d-none d-lg-block" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <!--<li class="nav-item"><a class="nav-link" href="#">ê²€ìƒ‰</a></li>-->
					<li class="nav-item"><a class="nav-link" href="/order/notifications"><i class="fa-solid fa-bell me-1"></i>ì•Œë¦¼</a></li>
                    <li class="nav-item"><a class="nav-link" href="/order/list">ì£¼ë¬¸ ëª©ë¡</a></li>
                    <!--<li class="nav-item"><a class="nav-link" href="#"><i class="fa-solid fa-cart-shopping me-1"></i>ì¥ë°”êµ¬ë‹ˆ</a></li>-->
                    <!--<li class="nav-item"><a class="nav-link btn btn-dark text-white ms-3 px-3 rounded-pill" href="#">ë¡œê·¸ì•„ì›ƒ</a></li>-->
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <div class="p-4 p-md-5 mb-4 rounded text-bg-dark d-flex align-items-center justify-content-between" 
             style="background: linear-gradient(45deg, #1a1a1a, #2c2c2c);">
            <div>
                <h1 class="display-5 fw-bold text-danger">Holiday Sale</h1>
                <p class="col-md-8 fs-5">ë”°ëœ»í•œ ê²¨ìš¸ì„ ìœ„í•œ ìµœê³ ì˜ ì„ íƒ. <br>ìµœì ì˜ ì˜¨ë„ì™€ ìŠµë„ë¥¼ ë§ì¶°ì£¼ëŠ” ìŠ¤ë§ˆíŠ¸ ìƒí’ˆë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”.</p>
            </div>
            <div class="d-none d-md-block">
                <i class="fa-solid fa-gift fa-5x text-danger"></i>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold border-start border-4 border-danger ps-3 mb-0">ì¶”ì²œ ìƒí’ˆ</h3>
            <span class="text-muted">ì „ì²´ë³´ê¸° <i class="fa-solid fa-chevron-right"></i></span>
        </div>

        <div class="row g-3">
            
            <div th:if="${#lists.isEmpty(productList)}" class="col-12 text-center py-5">
                <p class="text-muted">í˜„ì¬ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>

			<div class="col-6 col-lg-3" th:each="product : ${productList}">
			    <div class="card product-card h-100">
			        
			        <a th:href="@{/productList/{id}(id=${product.productId})}" class="text-decoration-none text-dark">
						<!-- ì´ë¯¸ì§€ URLì´ ìˆëŠ” ê²½ìš°: DBì— ì €ì¥ëœ ì´ë¯¸ì§€ -->
					    <img th:if="${product.imageUrl != null}"
					         th:src="${product.imageUrl}"
					         class="card-img-top"
					         th:alt="${product.productName}">

					    <!-- ì´ë¯¸ì§€ URLì´ ì—†ëŠ” ê²½ìš°: ê¸°ì¡´ í”Œë ˆì´ìŠ¤í™€ë” -->
					    <img th:if="${product.imageUrl == null}"
					         th:src="|https://placehold.co/300x300/f8f9fa/D42426?text=${product.productName}|"
					         class="card-img-top"
					         th:alt="${product.productName}">
			        </a>
			        
			        <div class="card-body d-flex flex-column">
			            <small class="text-muted mb-1">
			                <i class="fa-solid fa-shop"></i> <span th:text="${product.sellerId}">íŒë§¤ì</span>
			            </small>
			            
			            <a th:href="@{/productList/{id}(id=${product.productId})}" class="text-decoration-none text-dark">
			                <h5 class="card-title text-truncate" th:text="${product.productName}">ìƒí’ˆëª…</h5>
			            </a>
			           
			            <div class="mb-2">
			                <span class="spec-badge">
			                    <i class="fa-solid fa-temperature-half"></i> 
			                    <span th:text="|${product.minTemperature}Â°C ~ ${product.maxTemperature}Â°C|"></span>
			                </span>
			                <span class="spec-badge">
			                    <i class="fa-solid fa-droplet"></i> 
			                    <span th:text="|${product.minHumidity}% ~ ${product.maxHumidity}%|"></span>
			                </span>
			            </div>
						<button type="button" 
						        class="btn btn-outline-danger rounded-circle shadow-sm d-flex justify-content-center align-items-center"
						        style="width: 35px; height: 35px; padding: 0;"
						        th:onclick="addToCart([[${product.productId}]])">
						    <i class="fa-solid fa-cart-plus"></i>
						</button>
			        </div>
			    </div>
			</div>
            </div> </div>

    <nav class="mobile-bottom-nav fixed-bottom d-lg-none">
        <div class="container-fluid">
            <div class="row text-center py-2">
                <div class="col-3">
                    <a href="#" class="mobile-nav-item active d-flex flex-column align-items-center">
                        <i class="fa-solid fa-house fs-5 mb-1"></i><span>í™ˆ</span>
                    </a>
                </div>
                <div class="col-3">
                    <a href="#" class="mobile-nav-item d-flex flex-column align-items-center">
                        <i class="fa-solid fa-magnifying-glass fs-5 mb-1"></i><span>ê²€ìƒ‰</span>
                    </a>
                </div>
                <div class="col-3">
                    <a href="#" class="mobile-nav-item d-flex flex-column align-items-center">
                        <i class="fa-solid fa-list-check fs-5 mb-1"></i><span>ì£¼ë¬¸</span>
                    </a>
                </div>
                <div class="col-3">
                    <a href="#" class="mobile-nav-item d-flex flex-column align-items-center">
                        <i class="fa-solid fa-cart-shopping fs-5 mb-1"></i>
                        <span class="position-relative">ì¥ë°”êµ¬ë‹ˆ
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">2</span>
                        </span>
                    </a>
                </div>
            </div>
        </div>
    </nav>
	
	<div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
	    <div class="modal-dialog modal-dialog-centered">
	        <div class="modal-content">
	            <div class="modal-header border-0">
	                <h5 class="modal-title fw-bold"><i class="fa-solid fa-check-circle text-success me-2"></i>ì•Œë¦¼</h5>
	                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	            </div>
	            <div class="modal-body text-center py-4">
	                <p class="mb-0 fs-5">ìƒí’ˆì´ ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤!</p>
	            </div>
	            <div class="modal-footer border-0 justify-content-center gap-2">
	                <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">ê³„ì† ì‡¼í•‘í•˜ê¸°</button>
	                <a href="/cart" class="btn btn-danger px-4">ì¥ë°”êµ¬ë‹ˆ ì´ë™</a>
	            </div>
	        </div>
	    </div>
	</div>
	
	<!-- ì˜¤ë¥¸ìª½ í•˜ë‹¨ Toast ì˜ì—­ -->
	<div id="toastContainer" 
			     class="position-fixed bottom-0 end-0 p-3"
			     style="z-index:9999;"></div>

	<script>
	    function addToCart(productId) {
	        // ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ fetch('/cart/add', ...) ë¡œ ì„œë²„ì— DB ì €ì¥ì„ ìš”ì²­í•´ì•¼ í•©ë‹ˆë‹¤.
	        // í˜„ì¬ëŠ” UI ë™ì‘ í™•ì¸ì„ ìœ„í•´ ì„±ê³µí–ˆë‹¤ê³  ê°€ì •í•˜ê³  ëª¨ë‹¬ë§Œ ë„ì›ë‹ˆë‹¤.
	        
	        console.log("ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì‹œë„: Product ID " + productId);
	        
	        // ë¶€íŠ¸ìŠ¤íŠ¸ë© ëª¨ë‹¬ ë„ìš°ê¸°
	        const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
	        cartModal.show();
	    }
		
		// ì—ëŸ¬ ì•Œë¦¼ ë°›ì•„ì˜¤ê¸°
		function showToast(orderId, errorCnt) {

				    const toastContainer = document.getElementById("toastContainer");

				    // í† ìŠ¤íŠ¸ HTML ë™ì  ìƒì„±
				    const toastHtml = `
				        <div class="toast text-bg-danger border-0 mb-2" role="alert"
				             data-bs-autohide="true" data-bs-delay="5000"
				             style="cursor:pointer;"
				             onclick="location.href='/order/monitor/${orderId}'">
				            <div class="d-flex">
				                <div class="toast-body">
				                    ğŸ“¢ ì£¼ë¬¸ë²ˆí˜¸ <b>${orderId}</b> ì—ì„œ ì´ìƒ ì˜¨/ìŠµë„ ë°œìƒ : <b>${errorCnt}ê±´</b>
				                </div>
				                <button type="button" class="btn-close btn-close-white me-2 m-auto"
				                        data-bs-dismiss="toast"></button>
				            </div>
				        </div>
				    `;

				    // DOMì— ì¶”ê°€
				    toastContainer.insertAdjacentHTML("beforeend", toastHtml);

				    // ê°€ì¥ ìµœê·¼ ì¶”ê°€ëœ í† ìŠ¤íŠ¸ ì„ íƒ í›„ show
				    const addedToast = toastContainer.lastElementChild;
				    const toast = new bootstrap.Toast(addedToast);
				    toast.show();
				}
				
				function connectSensor() {
					            const sseUrl = `/alert/subscribe/0`;
					            console.log(`[AdminMonitor] [2] SSE ì—°ê²° ì‹œë„: ${sseUrl}`);

					            // SSE ì—°ê²°
					            eventSource = new EventSource(sseUrl);

					            // [ë””ë²„ê¹… 3] ì—°ê²° ì„±ê³µ ì‹œ
					            eventSource.onopen = function() {
					                console.log("[AdminMonitor] [3] SSE ì—°ê²° ì„±ê³µ (Connected)");
					            };

					            // [ë””ë²„ê¹…ìš©] ì´ë¦„ ì—†ëŠ” ì´ë²¤íŠ¸ ìˆ˜ì‹  í™•ì¸ (í˜¹ì‹œ ë°±ì—”ë“œì—ì„œ ì´ë¦„ì„ ì•ˆ ë³´ëƒˆì„ ê²½ìš° ëŒ€ë¹„)
					            eventSource.onmessage = function(event) {
					                console.log("[AdminMonitor] [DEBUG] ì´ë¦„ ì—†ëŠ” ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
					            };

								eventSource.addEventListener("errorData", function(event) {

								    const d = JSON.parse(event.data);

								    // deviceId & errorCountë§Œ ì¶”ì¶œ
								    const deviceId = d.deviceId;
								    const cnt = d.errorCount ?? 1;  // ê°¯ìˆ˜ ì—†ìœ¼ë©´ ê¸°ë³¸ 1ê±´

									// ë¨¼ì € orderId ì¡°íšŒ
									    fetch(`/retrieve/orderId/${deviceId}`)
									        .then(res => res.text())
									        .then(orderId => {
									            console.log("ì¡°íšŒëœ orderId:", orderId);

									            // ì¡°íšŒ ì„±ê³µ í›„ í† ìŠ¤íŠ¸ ë„ìš°ê¸°
									            showToast(orderId, cnt);
									        })
									        .catch(err => {
									            console.error("orderId ì¡°íšŒ ì‹¤íŒ¨:", err);
									        });
								});

					            eventSource.onerror = (err) => {
					                console.error("[AdminMonitor] âŒ SSE ì—°ê²° ëŠê¹€/ì—ëŸ¬:", err);
					            };
					        }
							
							connectSensor();
	</script>
	
	
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>