#include <WiFi.h>
#include <HTTPClient.h>

const char* ssid     = "YOUR_SSID";
const char* password = "YOUR_PASSWORD";

// âœ… ì´ ë³´ë“œì˜ deviceId
String deviceId = "01";

// âœ… ì„œë²„ URL (ë””ë°”ì´ìŠ¤ë³„)
String baseUrl   = "http://146.56.111.104:9090";
String postUrl   = baseUrl + "/api/data";
String statusUrl = baseUrl + "/api/sensor/" + deviceId + "/status";

float temperature = 0.0;
float humidity    = 0.0;

bool isActive = false;

void setup() {
  Serial.begin(115200);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nâœ… WiFi Connected");
}

void loop() {
  checkServerStatus();   // ì„œë²„ê°€ ì´ ê¸°ê¸°ë¥¼ ì¼°ëŠ”ì§€/ê»ëŠ”ì§€ í™•ì¸

  if (isActive) {
    sendSensorData();    // ONì¼ ë•Œë§Œ ì „ì†¡
  } else {
    Serial.println("â¸ STOP ìƒíƒœ â†’ ëŒ€ê¸° ì¤‘...");
  }

  delay(5000);
}

// âœ… ì„œë²„ì—ì„œ ì´ deviceIdì˜ active ìƒíƒœ í™•ì¸
void checkServerStatus() {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  http.begin(statusUrl); 

  int resCode = http.GET();

  if (resCode == 200) {
    String response = http.getString();
    Serial.println("ğŸ“¥ status ì‘ë‹µ: " + response);

    // ì•„ì£¼ ë‹¨ìˆœ íŒŒì‹± (active:true/false í¬í•¨ ì—¬ë¶€ë§Œ ì²´í¬)
    if (response.indexOf("true") > 0) {
      isActive = true;
    } else {
      isActive = false;
    }
  } else {
    Serial.print("âŒ status ì¡°íšŒ ì‹¤íŒ¨: ");
    Serial.println(resCode);
  }

  http.end();
}

// âœ… ì‹¤ì œ ì„¼ì„œ ë°ì´í„° ì „ì†¡
void sendSensorData() {
  if (WiFi.status() != WL_CONNECTED) return;

  HTTPClient http;
  http.begin(postUrl);
  http.addHeader("Content-Type", "application/json");

  String jsonData = "{";
  jsonData += "\"deviceId\":\"" + deviceId + "\",";
  jsonData += "\"temperature\":" + String(temperature, 1) + ",";
  jsonData += "\"humidity\":" + String(humidity, 1);
  jsonData += "}";

  Serial.println("ğŸ“¤ ì „ì†¡: " + jsonData);

  int resCode = http.POST(jsonData);
  Serial.print("âœ… ì‘ë‹µ ì½”ë“œ: ");
  Serial.println(resCode);

  http.end();
}
