<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ | Fresh Chain</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ê´€ë¦¬ì í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        body { background-color: #F5F7FB; }
        
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            width: 260px;
            height: 100vh;
            background: #212529; /* ë‹¤í¬ í…Œë§ˆ */
            color: #fff;
            position: fixed;
            top: 0; left: 0;
            padding-top: 20px;
            z-index: 1000;
        }
        .sidebar .nav-link {
            color: #adb5bd;
            padding: 15px 25px;
            font-size: 1rem;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: #fff;
            background-color: #D42426; /* ë¸Œëœë“œ í¬ì¸íŠ¸ ì»¬ëŸ¬ (Red) */
        }
        .brand-logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            text-align: center;
            margin-bottom: 30px;
            text-decoration: none;
            display: block;
        }

        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ (ì‚¬ì´ë“œë°” ë„ˆë¹„ë§Œí¼ ë°€ê¸°) */
        .main-content {
            margin-left: 260px;
            padding: 30px;
        }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .stat-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            cursor: pointer;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .icon-box {
            width: 50px; height: 50px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <a href="/admin" class="brand-logo">
            <i class="fa-solid fa-temperature-low me-2"></i>Fresh Admin
        </a>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="/admin">
                    <i class="fa-solid fa-chart-pie me-3"></i>ëŒ€ì‹œë³´ë“œ
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/admin/orders">
                    <i class="fa-solid fa-truck-fast me-3"></i>ì£¼ë¬¸/ë°°ì†¡ ê´€ë¦¬
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <i class="fa-solid fa-users me-3"></i>íšŒì› ê´€ë¦¬
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <i class="fa-solid fa-gear me-3"></i>ì‹œìŠ¤í…œ ì„¤ì •
                </a>
            </li>
        </ul>
        <div class="mt-auto p-4" style="position: absolute; bottom: 0; width: 100%;">
            <a href="/logout" class="btn btn-outline-light w-100 btn-sm">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </nav>

    <main class="main-content">
        
        <header class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark">Dashboard</h2>
                <p class="text-muted">ì‹¤ì‹œê°„ ë°°ì†¡ ë° ì˜¨/ìŠµë„ ëª¨ë‹ˆí„°ë§ í˜„í™©ì…ë‹ˆë‹¤.</p>
            </div>
            <div class="d-flex align-items-center bg-white p-2 rounded shadow-sm px-3">
                <div class="me-3 text-end">
                    <div class="fw-bold">ê´€ë¦¬ì ë‹˜</div>
                    <small class="text-muted">Master Admin</small>
                </div>
                <div class="bg-secondary rounded-circle" style="width: 40px; height: 40px;"></div>
            </div>
        </header>

        <div class="row g-4 mb-4">
            
            <div class="col-md-4">
                <div class="card stat-card bg-white" onclick="location.href='/admin/orders?status=SHIPPING'">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-box bg-primary bg-opacity-10 text-primary me-3">
                            <i class="fa-solid fa-truck"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">í˜„ì¬ ë°°ì†¡ ì¤‘</h6>
                            <h3 class="fw-bold mb-0" th:text="${totalShipping}">154</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card stat-card bg-danger text-white" onclick="location.href='/admin/orders?status=SHIPPING&alert=true'">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-box bg-white text-danger me-3">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                        </div>
                        <div>
                            <h6 class="text-white-50 mb-1">ì˜¨ë„ ì´íƒˆ ê²½ê³ </h6>
                            <h3 class="fw-bold mb-0" th:text="${alertCount}">3</h3>
                        </div>
                        <span class="badge bg-white text-danger ms-auto">ì¡°ì¹˜ í•„ìš”</span>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card stat-card bg-white">
                    <div class="card-body d-flex align-items-center">
                        <div class="icon-box bg-success bg-opacity-10 text-success me-3">
                            <i class="fa-solid fa-server"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">ì„¼ì„œ ê°€ë™ë¥ </h6>
                            <h3 class="fw-bold mb-0"><span th:text="${sensorActive}">98</span>%</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="fw-bold mb-0">ğŸ“‰ ì£¼ê°„ ì˜¨ë„ ì´íƒˆ ë°œìƒ ì¶”ì´</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="issueChart" height="100"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="fw-bold mb-0">âš¡ ë¹ ë¥¸ ì‘ì—…</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="/admin/orders" class="btn btn-outline-dark p-3 text-start">
                                <i class="fa-solid fa-list me-2"></i> ì „ì²´ ì£¼ë¬¸ ëª©ë¡ ì¡°íšŒ
                            </a>
                            <a href="#" class="btn btn-outline-dark p-3 text-start">
                                <i class="fa-solid fa-file-export me-2"></i> ì›”ê°„ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
                            </a>
                            <a href="#" class="btn btn-outline-danger p-3 text-start">
                                <i class="fa-solid fa-bell me-2"></i> ê¸´ê¸‰ ì•Œë¦¼ ë°œì†¡ ì„¤ì •
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </div> </main>
		
		<!-- ì˜¤ë¥¸ìª½ í•˜ë‹¨ Toast ì˜ì—­ -->
		<div id="toastContainer" 
		     class="position-fixed bottom-0 end-0 p-3"
		     style="z-index:9999;"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	
	<script th:inline="javascript">
	  const weekLabels = /*[[${weekLabels}]]*/ [];
	  const weekCounts = /*[[${weekCounts}]]*/ [];
	</script>
	
    <script>
        // ëŒ€ì‹œë³´ë“œ ì°¨íŠ¸ (Mock Data)
		const ctx = document.getElementById('issueChart').getContext('2d');
		new Chart(ctx, {
		  type: 'bar',
		  data: {
		    labels: weekLabels,
		    datasets: [{ data: weekCounts, backgroundColor:'#D42426', borderRadius:5 }]
		  },
		  options: {
		    responsive: true,
		    plugins: { legend: { display: false } },
		    scales: {
		      y: {
		        beginAtZero: true,
		        ticks: {
		          stepSize: 1,         
		          precision: 0          
		        }
		      }
		    }
		  }
		});
		
		
		function showToast(orderId, errorCnt) {

		    const toastContainer = document.getElementById("toastContainer");

		    // í† ìŠ¤íŠ¸ HTML ë™ì  ìƒì„±
		    const toastHtml = `
		        <div class="toast text-bg-danger border-0 mb-2" role="alert"
		             data-bs-autohide="true" data-bs-delay="5000"
		             style="cursor:pointer;"
		             onclick="location.href='/admin/orders/${orderId}'">
		            <div class="d-flex">
		                <div class="toast-body">
		                    ğŸ“¢ ì£¼ë¬¸ë²ˆí˜¸ <b>${orderId}</b> ì—ì„œ ì˜¤ë¥˜ ë°œìƒ: <b>${errorCnt}ê±´</b>
		                </div>
		                <button type="button" class="btn-close btn-close-white me-2 m-auto"
		                        data-bs-dismiss="toast"></button>
		            </div>
		        </div>
		    `;

		    // DOMì— ì¶”ê°€
		    toastContainer.insertAdjacentHTML("beforeend", toastHtml);

		    // ê°€ì¥ ìµœê·¼ ì¶”ê°€ëœ í† ìŠ¤íŠ¸ ì„ íƒ í›„ show
		    const addedToast = toastContainer.lastElementChild;
		    const toast = new bootstrap.Toast(addedToast);
		    toast.show();
		}
		
		function connectSensor() {
			            const sseUrl = `/alert/subscribe/0`;
			            console.log(`[AdminMonitor] [2] SSE ì—°ê²° ì‹œë„: ${sseUrl}`);

			            // SSE ì—°ê²°
			            eventSource = new EventSource(sseUrl);

			            // [ë””ë²„ê¹… 3] ì—°ê²° ì„±ê³µ ì‹œ
			            eventSource.onopen = function() {
			                console.log("[AdminMonitor] [3] SSE ì—°ê²° ì„±ê³µ (Connected)");
			            };

			            // [ë””ë²„ê¹…ìš©] ì´ë¦„ ì—†ëŠ” ì´ë²¤íŠ¸ ìˆ˜ì‹  í™•ì¸ (í˜¹ì‹œ ë°±ì—”ë“œì—ì„œ ì´ë¦„ì„ ì•ˆ ë³´ëƒˆì„ ê²½ìš° ëŒ€ë¹„)
			            eventSource.onmessage = function(event) {
			                console.log("[AdminMonitor] [DEBUG] ì´ë¦„ ì—†ëŠ” ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
			            };

						eventSource.addEventListener("errorData", function(event) {

						    const d = JSON.parse(event.data);

						    // deviceId & errorCountë§Œ ì¶”ì¶œ
						    const deviceId = d.deviceId;
						    const cnt = d.errorCount ?? 1;  // ê°¯ìˆ˜ ì—†ìœ¼ë©´ ê¸°ë³¸ 1ê±´

							// ë¨¼ì € orderId ì¡°íšŒ
							    fetch(`/retrieve/orderId/${deviceId}`)
							        .then(res => res.text())
							        .then(orderId => {
							            console.log("ì¡°íšŒëœ orderId:", orderId);

							            // ì¡°íšŒ ì„±ê³µ í›„ í† ìŠ¤íŠ¸ ë„ìš°ê¸°
							            showToast(orderId, cnt);
							        })
							        .catch(err => {
							            console.error("orderId ì¡°íšŒ ì‹¤íŒ¨:", err);
							        });
						});

			            eventSource.onerror = (err) => {
			                console.error("[AdminMonitor] âŒ SSE ì—°ê²° ëŠê¹€/ì—ëŸ¬:", err);
			            };
			        }
					
					connectSensor();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>