<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>관리자 | 주문 관리</title>
  <link rel="stylesheet" href="/css/base.css"/>
</head>
<body class="app-body">
<div class="app-shell">

  <!-- 페이지 헤더 -->
  <header class="page-header">
    <div>
      <h1 class="page-title">주문 관리</h1>
      <p class="page-subtitle">
        구매자 정보, 주문 상태, 모니터링 화면을 한 곳에서 관리합니다.
      </p>
    </div>
  </header>

  <!-- 필터 + 테이블 카드 -->
  <section class="card card--filter">

    <!-- 필터 -->
    <form id="filterForm" class="filter-bar filter-bar--grid">
      <div class="filter-group">
        <label for="buyer" class="filter-label">구매자</label>
        <input
          id="buyer"
          name="buyer"
          class="input"
          placeholder="구매자 이름 / 이메일"
        />
      </div>

      <div class="filter-group">
        <label for="product" class="filter-label">상품</label>
        <input
          id="product"
          name="product"
          class="input"
          placeholder="제품명 / SKU"
        />
      </div>

      <div class="filter-group">
        <label for="status" class="filter-label">주문 상태</label>
        <select id="status" name="status" class="select">
          <option value="">상태 전체</option>
          <option value="PENDING">대기</option>
          <option value="SHIPPING">배송중</option>
          <option value="DONE">완료</option>
        </select>
      </div>

      <div class="filter-group filter-group--buttons">
        <label class="filter-label">&nbsp;</label>
        <div class="filter-actions">
          <button class="btn btn-primary" type="submit">검색</button>
          <button class="btn btn-soft" type="button" id="resetBtn">초기화</button>
        </div>
      </div>
    </form>

    <!-- 테이블 -->
    <div class="table-wrapper" style="margin-top: 14px;">
      <table class="table">
        <thead>
        <tr>
          <th style="width:34px">
            <input type="checkbox" id="chkAll"/>
          </th>
          <th>주문번호</th>
          <th>구매자</th>
          <th>상품</th>
          <th>금액</th>
          <th>상태</th>
          <th>생성일</th>
          <th>액션</th>
        </tr>
        </thead>
        <tbody id="orderRows"></tbody>
      </table>
    </div>

    <!-- 페이지네이션 -->
    <div id="pager" class="pager pager--center"></div>
  </section>
</div>

<script>
  // 임시(mock) API (나중에 /api/admin/orders 로 교체 예정)
  const API = {
    list:  (qs) => fetch('/mock/orders?' + qs),
    start: (id) => fetch('/mock/orders/'+id+'/start', {method:'POST'}),
    done:  (id) => fetch('/mock/orders/'+id+'/complete', {method:'POST'}),
  };

  let lastParams = {page:0,size:10,sort:'createdAt,DESC',buyer:'',product:'',status:''};

  // 초기 로딩
  window.addEventListener('DOMContentLoaded', ()=> load());

  // 전체 로딩
  async function load(params=lastParams){
    lastParams = params;
    const qs = new URLSearchParams(params).toString();
    const res = await API.list(qs);
    const data = await res.json(); // {content,total,page,size}
    renderRows(data.content || []);
    renderPager(data.total || 0, data.page || 0, data.size || 10);
  }

  // 행 렌더
  function renderRows(list){
    const tbody = document.querySelector('#orderRows');
    tbody.innerHTML = list.map(o=>`
      <tr>
        <td><input type="checkbox" data-id="${o.id}"></td>
        <td><span class="mono">${o.orderNo}</span></td>
        <td>
          ${o.buyerName}<br>
          <small class="mono">${o.buyerEmail}</small>
        </td>
        <td>${o.productName}</td>
        <td>${(o.totalPrice||0).toLocaleString()}원</td>
        <td>${o.status}</td>
        <td>${o.createdAt}</td>
        <td class="actions">
          <button class="btn btn-soft btn-xs" onclick="openMonitor(${o.id})">모니터링</button>
          ${o.status==='PENDING'
            ? `<button class="btn btn-soft btn-xs" onclick="markStart(${o.id})">배송 시작</button>` : ''}
          ${o.status==='SHIPPING'
            ? `<button class="btn btn-primary btn-xs" onclick="markDone(${o.id})">완료</button>` : ''}
        </td>
      </tr>
    `).join('');
  }

  // 페이징 렌더
  function renderPager(total, page, size){
    const pageCount = Math.max(1, Math.ceil(total/size));
    const $pager = document.querySelector('#pager');
    let html = '';
    for(let i=0;i<pageCount;i++){
      html += `<span class="pill ${i===page?'active':''}" onclick="gotoPage(${i})">${i+1}</span>`
    }
    $pager.innerHTML = html;
  }
  function gotoPage(p){
    load({...lastParams, page:p});
  }

  // 액션
  function openMonitor(id){
    // 팀원이 만든 /admin/orders/{id} 모니터링 페이지로 새 탭
    window.open('/admin/orders/'+id, '_blank');
  }
  async function markStart(id){
    await API.start(id);
    load(lastParams);
  }
  async function markDone(id){
    await API.done(id);
    load(lastParams);
  }

  // 폼 이벤트
  document.querySelector('#filterForm').addEventListener('submit', e=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    load({
      ...lastParams,
      page:0,
      buyer:  fd.get('buyer')   || '',
      product:fd.get('product') || '',
      status: fd.get('status')  || ''
    });
  });
  document.querySelector('#resetBtn').onclick = ()=>{
    document.querySelector('#filterForm').reset();
    load({page:0,size:10,sort:'createdAt,DESC',buyer:'',product:'',status:''});
  };
</script>
</body>
</html>
