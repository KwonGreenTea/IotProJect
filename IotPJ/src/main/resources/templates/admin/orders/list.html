<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ ê·œ ì£¼ë¬¸ ì²˜ë¦¬ | Fresh Admin</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ê´€ë¦¬ì ê³µí†µ ìŠ¤íƒ€ì¼ */
        body { background-color: #F5F7FB; font-family: 'Noto Sans KR', sans-serif; }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 260px; height: 100vh;
            background: #212529; color: #fff;
            position: fixed; top: 0; left: 0;
            padding-top: 20px; z-index: 1000;
        }
        .sidebar .nav-link { color: #adb5bd; padding: 15px 25px; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: #fff; background-color: #D42426;
        }
        .brand-logo {
            font-size: 1.5rem; font-weight: bold; color: #fff;
            text-align: center; margin-bottom: 30px; text-decoration: none; display: block;
        }

        /* ë©”ì¸ ì˜ì—­ */
        .main-content { margin-left: 260px; padding: 30px; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-card {
            background: white; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: none; overflow: hidden;
        }
        .table thead th {
            background-color: #f1f3f5; border-bottom: 2px solid #dee2e6;
            color: #495057; font-weight: 700; padding: 16px;
        }
        .table tbody td {
            vertical-align: middle; padding: 16px; font-size: 0.95rem;
        }

        /* [í•µì‹¬] ìƒíƒœë³„ í–‰ ìŠ¤íƒ€ì¼ */
        /* ë°°ì†¡ ì¤‘(ì™„ë£Œëœ ì—…ë¬´)ì€ ë°°ê²½ì„ ì•½ê°„ ì–´ë‘¡ê²Œ ì²˜ë¦¬í•˜ì—¬ ì‹œì„  ë¶„ì‚° ë°©ì§€ */
        tr.row-shipping { background-color: #f8f9fa; }
        tr.row-shipping td { color: #868e96; }
        
        /* ì‹ ê·œ ì£¼ë¬¸(í•´ì•¼ í•  ì—…ë¬´)ì€ í°ìƒ‰ ë°°ê²½ ìœ ì§€ + í…ìŠ¤íŠ¸ ì§„í•˜ê²Œ */
        tr.row-new { background-color: #ffffff; }
        tr.row-new td { color: #212529; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <a href="/admin" class="brand-logo"><i class="fa-solid fa-temperature-low me-2"></i>Fresh Admin</a>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="/admin"><i class="fa-solid fa-chart-pie me-3"></i>ëŒ€ì‹œë³´ë“œ</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/orders"><i class="fa-solid fa-truck-fast me-3"></i>ì£¼ë¬¸ ëª©ë¡</a>
            </li>
            <li class="nav-item"><a class="nav-link" href="#"><i class="fa-solid fa-users me-3"></i>íšŒì› ê´€ë¦¬</a></li>
            <li class="nav-item"><a class="nav-link" href="#"><i class="fa-solid fa-gear me-3"></i>ì„¤ì •</a></li>
        </ul>
        <div class="mt-auto p-4" style="position: absolute; bottom: 0; width: 100%;">
            <a href="/logout" class="btn btn-outline-light w-100 btn-sm">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </nav>

    <main class="main-content">
        
        <header class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark">ğŸ“¦ ì£¼ë¬¸ ì ‘ìˆ˜ í˜„í™©</h2>
                <p class="text-muted mb-0">ì‹ ê·œ ì£¼ë¬¸ì„ í™•ì¸í•˜ê³  <strong class="text-primary">ë°°ì†¡ ì‹œì‘</strong> ì²˜ë¦¬ë¥¼ ì§„í–‰í•˜ì„¸ìš”.</p>
            </div>
            <div class="d-flex gap-3">
                <div class="bg-white px-3 py-2 rounded shadow-sm border">
                    <small class="text-muted d-block">ì²˜ë¦¬ ëŒ€ê¸°</small>
                    <strong class="text-primary fs-5" id="pendingCount">-</strong> ê±´
                </div>
            </div>
        </header>

        <div class="card table-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle" id="orderTable">
                        <thead>
                            <tr>
                                <th class="text-center">Order ID</th>
                                <th>êµ¬ë§¤ì (User)</th>
                                <th>ì£¼ë¬¸ ìƒí’ˆ</th>
                                <th>ì£¼ë¬¸ ì¼ì‹œ</th>
                                <th class="text-end">ê¸ˆì•¡</th>
                                <th class="text-center">ìƒíƒœ</th>
                                <th class="text-center">ì‘ì—… (Action)</th>
                            </tr>
                        </thead>
                        <tbody>
                            
                            <tr th:if="${#lists.isEmpty(orderList)}">
                                <td colspan="7" class="text-center py-5">
                                    <p class="text-muted mb-0">í˜„ì¬ ì ‘ìˆ˜ëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                </td>
                            </tr>

                            <tr th:each="order : ${orderList}" 
                                th:class="${order.isActive != 'Y'} ? 'row-new' : 'row-shipping'"
                                th:data-status="${order.isActive != 'Y'} ? 'NEW' : 'SHIPPING'">
                                
                                <td class="text-center fw-bold" th:text="|#${order.orderId}|">#101</td>
                                
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light rounded-circle p-2 me-2 text-secondary">
                                            <i class="fa-solid fa-user"></i>
                                        </div>
                                        <div>
                                            <strong th:text="${order.userId}">user01</strong>
                                            <div class="small text-muted" th:if="${order.isActive == 'Y'}" th:text="|ìš´ì†¡ì¥: ${order.deliveryId}|"></div>
                                        </div>
                                    </div>
                                </td>

                                <td>
                                    <span class="badge bg-light text-dark border me-1">ID: <span th:text="${order.productId}"></span></span>
                                    <small class="text-muted"><i class="fa-solid fa-store ms-1 me-1"></i><span th:text="${order.sellerId}"></span></small>
                                </td>

                                <td th:text="${order.orderedAt}">2023-11-27</td>

                                <td class="text-end fw-bold">
                                    <span th:text="${#numbers.formatInteger(order.totalPrice, 0, 'COMMA')}">30,000</span>ì›
                                </td>

                                <td class="text-center">
                                    <span th:unless="${order.isActive == 'Y'}" class="badge bg-primary rounded-pill px-3">
                                        ì‹ ê·œ ì£¼ë¬¸
                                    </span>
                                    <span th:if="${order.isActive == 'Y'}" class="badge bg-secondary bg-opacity-25 text-secondary rounded-pill px-3">
                                        ë°°ì†¡ ì¤‘
                                    </span>
                                </td>

                                <td class="text-center">
                                    
									<button th:unless="${order.isActive == 'Y'}"
									        class="btn btn-primary btn-sm shadow-sm fw-bold px-3"
									        th:onclick="|startShipping(${order.orderId}, this)|">
									    <i class="fa-solid fa-box-open me-1"></i> ë°°ì†¡ ì‹œì‘
									</button>

                                    <button th:if="${order.isActive == 'Y'}"
                                            class="btn btn-outline-secondary btn-sm px-3" 
                                            th:onclick="|openMonitor(${order.orderId})|">
                                        <i class="fa-solid fa-desktop me-1"></i> ëª¨ë‹ˆí„°ë§
                                    </button>

                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ 'ì‹ ê·œ ì£¼ë¬¸'ì„ ìƒë‹¨ìœ¼ë¡œ ì •ë ¬í•˜ëŠ” í•¨ìˆ˜
        document.addEventListener("DOMContentLoaded", function() {
            const table = document.getElementById("orderTable");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));

            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ íŒ¨ìŠ¤
            if(rows.length === 0 || rows[0].cells.length < 2) return;

            // ì •ë ¬ ë¡œì§: data-statusê°€ 'NEW'ì¸ ê²ƒì„ ì•ìœ¼ë¡œ, 'SHIPPING'ì„ ë’¤ë¡œ
            rows.sort((a, b) => {
                const statusA = a.getAttribute('data-status');
                const statusB = b.getAttribute('data-status');

                // NEWê°€ SHIPPINGë³´ë‹¤ ìš°ì„ 
                if (statusA === 'NEW' && statusB !== 'NEW') return -1;
                if (statusA !== 'NEW' && statusB === 'NEW') return 1;
                return 0; // ê°™ìœ¼ë©´ ìˆœì„œ ìœ ì§€ (ë³´í†µ ìµœì‹ ìˆœì¼ í…Œë‹ˆ)
            });

            // ì •ë ¬ëœ ìˆœì„œëŒ€ë¡œ ë‹¤ì‹œ append
            rows.forEach(row => tbody.appendChild(row));

            // ì‹ ê·œ ì£¼ë¬¸ ê±´ìˆ˜ ì¹´ìš´íŠ¸í•´ì„œ ìƒë‹¨ í—¤ë”ì— í‘œì‹œ
            const newCount = rows.filter(r => r.getAttribute('data-status') === 'NEW').length;
            document.getElementById('pendingCount').innerText = newCount;
        });

        // 2. ë°°ì†¡ ì‹œì‘ ìš”ì²­ (Fetch)
		// [ê¸°ì¡´] ë°°ì†¡ ì‹œì‘ ìš”ì²­ í•¨ìˆ˜ ìˆ˜ì •
		    function startShipping(orderId, btnElement) {
		        // 1. í™•ì¸ ì ˆì°¨
		        if (!confirm(`[ì£¼ë¬¸ #${orderId}] ë°°ì†¡ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
		            return;
		        }

		        // 2. ì„œë²„ì— ìƒíƒœ ë³€ê²½ ìš”ì²­ (POST) - SSE ì•„ë‹˜!
		        fetch(`/admin/orders/${orderId}/ship`, {
		            method: 'POST',
		            headers: { 'Content-Type': 'application/json' }
		        })
		        .then(res => {
		            if (res.ok) {
		                // ì„±ê³µ ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­, ë„ˆë¬´ ìì£¼ ëœ¨ë©´ ê·€ì°®ì„ ìˆ˜ ìˆìŒ)
		                // alert("ë°°ì†¡ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.");

		                // 3. [í•µì‹¬] í™”ë©´ ìƒˆë¡œê³ ì¹¨ ì—†ì´ 'ë²„íŠ¼'ê³¼ 'ìƒíƒœ ë°°ì§€'ë§Œ êµì²´ (Button Switching)
		                
		                // (1) í•´ë‹¹ í–‰(tr) ì°¾ê¸°
		                const row = btnElement.closest('tr');
		                
		                // (2) ë°°ê²½ìƒ‰ ë° í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ë³€ê²½ (ì‹ ê·œ -> ë°°ì†¡ì¤‘ ìŠ¤íƒ€ì¼)
		                row.classList.remove('row-new');
		                row.classList.add('row-shipping');
		                row.setAttribute('data-status', 'SHIPPING');

		                // (3) ìƒíƒœ ë°°ì§€ ë³€ê²½ (ì‹ ê·œ ì£¼ë¬¸ -> ë°°ì†¡ ì¤‘)
		                const statusCell = row.cells[5]; // 6ë²ˆì§¸ ì¹¸(ì¸ë±ìŠ¤ 5)ì´ ìƒíƒœ ì¹¸ì´ë¼ê³  ê°€ì •
		                statusCell.innerHTML = `
		                    <span class="badge bg-secondary bg-opacity-25 text-secondary rounded-pill px-3">
		                        ë°°ì†¡ ì¤‘
		                    </span>
		                `;

		                // (4) ë²„íŠ¼ êµì²´ (ë°°ì†¡ ì‹œì‘ -> ëª¨ë‹ˆí„°ë§)
		                const actionCell = row.cells[6]; // 7ë²ˆì§¸ ì¹¸(ì¸ë±ìŠ¤ 6)ì´ ì•¡ì…˜ ì¹¸
		                actionCell.innerHTML = `
		                    <button class="btn btn-outline-secondary btn-sm px-3" 
		                            onclick="openMonitor(${orderId})">
		                        <i class="fa-solid fa-desktop me-1"></i> ëª¨ë‹ˆí„°ë§
		                    </button>
		                `;

		                // (ì˜µì…˜) ìƒë‹¨ í†µê³„ ìˆ«ì ì¤„ì´ê¸°
		                const countElem = document.getElementById('pendingCount');
		                let count = parseInt(countElem.innerText);
		                if(count > 0) countElem.innerText = count - 1;

		            } else {
		                alert("ì²˜ë¦¬ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
		            }
		        })
		        .catch(err => {
		            console.error(err);
		            alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
		        });
		    }

		    // ëª¨ë‹ˆí„°ë§ í™”ë©´ ì—´ê¸° (ì—¬ê¸°ì„œ ë¹„ë¡œì†Œ SSE ì—°ê²°ë¨)
		    function openMonitor(orderId) {
		        const url = `/admin/orders/${orderId}`;
		        window.open(url, '_blank', 'width=1280,height=900');
		    }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>