<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ | Fresh Admin</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #F5F7FB; font-family: 'Noto Sans KR', sans-serif; }
        .monitor-container { max-width: 1400px; margin: 0 auto; padding: 30px; }
        
        /* ì¹´ë“œ ë””ìì¸ */
        .card-custom {
            border: none; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            background: white; margin-bottom: 20px;
        }
        
        /* í˜„ì¬ ê°’ í‘œì‹œ ë°•ìŠ¤ */
        .stat-box { padding: 25px; text-align: center; height: 100%; border-radius: 12px; }
        .stat-title { color: #6c757d; font-size: 0.95rem; margin-bottom: 10px; font-weight: 500; }
        .stat-value { font-size: 3rem; font-weight: 800; line-height: 1.2; }
        
        /* ê·¸ë˜í”„ ì˜ì—­ */
        .chart-wrapper { position: relative; height: 400px; width: 100%; }

        /* ì• ë‹ˆë©”ì´ì…˜ (ê°’ ë³€ê²½ ì‹œ ê¹œë¹¡ì„) */
        .flash { animation: flash-animation 0.8s; }
        @keyframes flash-animation { 
            0% { opacity: 0.5; transform: scale(0.98); } 
            100% { opacity: 1; transform: scale(1); } 
        }
    </style>
</head>
<body>
	<div class="position-fixed top-0 end-0 p-3" style="z-index: 1050; margin-top: 60px;">
	        <button class="btn btn-light shadow-sm border" type="button" data-bs-toggle="offcanvas" data-bs-target="#infoSidebar">
	            <i class="fa-solid fa-list-ul me-2"></i>ë¡œê·¸ & ì •ë³´
	        </button>
	    </div>

	    <div class="offcanvas offcanvas-end" tabindex="-1" id="infoSidebar" style="width: 400px;">
	        <div class="offcanvas-header bg-light">
	            <h5 class="offcanvas-title fw-bold"><i class="fa-solid fa-circle-info me-2"></i>ë°°ì†¡ ìƒì„¸ ì •ë³´</h5>
	            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
	        </div>
	        <div class="offcanvas-body">
	            
	            <div class="mb-4">
	                <h6 class="fw-bold text-secondary border-bottom pb-2">ğŸ“¡ ì„¼ì„œ ê¸°ê¸° ìƒíƒœ</h6>
	                <div class="d-flex justify-content-between mt-2">
	                    <span>ë°°í„°ë¦¬ ì”ëŸ‰</span>
	                    <span class="text-success fw-bold"><i class="fa-solid fa-battery-full me-1"></i>85%</span>
	                </div>
	                <div class="d-flex justify-content-between mt-1">
	                    <span>ì‹ í˜¸ ê°•ë„</span>
	                    <span class="text-primary fw-bold"><i class="fa-solid fa-signal me-1"></i>ìš°ìˆ˜ (-65dBm)</span>
	                </div>
	            </div>

	            <div class="mb-4">
	                <h6 class="fw-bold text-secondary border-bottom pb-2">ğŸ“ ì—°ë½ì²˜ ì •ë³´</h6>
	                <div class="card bg-light border-0 mb-2">
	                    <div class="card-body p-2">
	                        <small class="text-muted d-block">ë°°ì†¡ ê¸°ì‚¬</small>
	                        <div class="d-flex justify-content-between align-items-center">
	                            <strong>ê¹€ì² ìˆ˜ ê¸°ì‚¬ë‹˜</strong>
	                            <a href="tel:010-1234-5678" class="btn btn-sm btn-success"><i class="fa-solid fa-phone"></i></a>
	                        </div>
	                    </div>
	                </div>
	                <div class="card bg-light border-0">
	                    <div class="card-body p-2">
	                        <small class="text-muted d-block">êµ¬ë§¤ì</small>
	                        <div class="d-flex justify-content-between align-items-center">
	                            <strong>ì´ì˜í¬ ê³ ê°ë‹˜</strong>
	                            <a href="tel:010-9876-5432" class="btn btn-sm btn-outline-dark"><i class="fa-solid fa-phone"></i></a>
	                        </div>
	                    </div>
	                </div>
	            </div>

	            <div class="mb-4">
	                <h6 class="fw-bold text-secondary border-bottom pb-2">ğŸš¨ ì•Œë¦¼/ì´ë²¤íŠ¸ ë¡œê·¸</h6>
	                <ul class="list-group list-group-flush small" id="eventLogList">
	                    <li class="list-group-item d-flex justify-content-between px-0">
	                        <span><span class="badge bg-danger me-2">ê²½ê³ </span>ì˜¨ë„ ì´íƒˆ (12.5Â°C)</span>
	                        <span class="text-muted">14:32:05</span>
	                    </li>
	                    <li class="list-group-item d-flex justify-content-between px-0">
	                        <span><span class="badge bg-success me-2">ì •ìƒ</span>ì˜¨ë„ íšŒë³µ (5.0Â°C)</span>
	                        <span class="text-muted">14:35:10</span>
	                    </li>
	                    <li class="list-group-item d-flex justify-content-between px-0">
	                        <span><span class="badge bg-secondary me-2">ì •ë³´</span>ë°°ì†¡ ì‹œì‘ ì²˜ë¦¬</span>
	                        <span class="text-muted">14:00:00</span>
	                    </li>
	                </ul>
	            </div>

	            <div class="d-grid">
	                <button class="btn btn-outline-dark">
	                    <i class="fa-solid fa-file-excel me-2"></i>ì˜¨/ìŠµë„ ì´ë ¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
	                </button>
	            </div>

	        </div>
	    </div>

    <div class="monitor-container">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark"><i class="fa-solid fa-satellite-dish me-2 text-danger"></i>ì‹¤ì‹œê°„ ë°°ì†¡ ê´€ì œ</h2>
                <p class="text-muted mb-0">ì£¼ë¬¸ë²ˆí˜¸ <strong class="text-dark" th:text="|#${orderId}|">#0</strong>ì˜ ì„¼ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì‹  ì¤‘ì…ë‹ˆë‹¤.</p>
            </div>
            <div class="d-flex gap-2">
                <button onclick="window.close()" class="btn btn-outline-secondary px-4">ë‹«ê¸°</button>
            </div>
        </div>

        <div class="row g-3 mb-4">
            
            <div class="col-lg-3 col-md-6">
                <div class="card-custom h-100 p-0 overflow-hidden">
                    <div class="stat-box bg-white">
                        <div class="stat-title"><i class="fa-solid fa-temperature-half me-1"></i>í˜„ì¬ ì˜¨ë„</div>
                        <div class="stat-value text-danger">
                            <span id="currTemp">--</span><span class="fs-4 text-muted fw-normal ms-1">Â°C</span>
                        </div>
                    </div>
                    <div class="bg-light p-2 text-center border-top">
                        <small class="text-muted">ì ì • ì˜¨ë„: 0 ~ 10Â°C</small> </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="card-custom h-100 p-0 overflow-hidden">
                    <div class="stat-box bg-white">
                        <div class="stat-title"><i class="fa-solid fa-droplet me-1"></i>í˜„ì¬ ìŠµë„</div>
                        <div class="stat-value text-primary">
                            <span id="currHumid">--</span><span class="fs-4 text-muted fw-normal ms-1">%</span>
                        </div>
                    </div>
                    <div class="bg-light p-2 text-center border-top">
                        <small class="text-muted">ì ì • ìŠµë„: 40 ~ 60%</small>
                    </div>
                </div>
            </div>

            <div class="col-lg-6 col-md-12">
                <div class="card-custom h-100 p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold m-0">ğŸ“ˆ ë°ì´í„° í†µê³„ (ëˆ„ì  ë²”ìœ„)</h5>
                        <span class="badge bg-success bg-opacity-10 text-success">
                            <i class="fa-solid fa-circle-check me-1"></i>ìˆ˜ì‹  ì¤‘
                        </span>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="p-3 border rounded bg-light text-center h-100">
                                <small class="text-muted d-block mb-1">ì˜¨ë„ ë³€í™” í­</small>
                                <div class="fw-bold fs-4 text-dark">
                                    <span class="text-primary" id="tempMin">--</span>
                                    <span class="text-muted mx-1">~</span>
                                    <span class="text-danger" id="tempMax">--</span>
                                </div>
                                <small class="text-muted">ìµœì € ~ ìµœê³  (Â°C)</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 border rounded bg-light text-center h-100">
                                <small class="text-muted d-block mb-1">ìŠµë„ ë³€í™” í­</small>
                                <div class="fw-bold fs-4 text-dark">
                                    <span class="text-primary" id="humidMin">--</span>
                                    <span class="text-muted mx-1">~</span>
                                    <span class="text-info" id="humidMax">--</span>
                                </div>
                                <small class="text-muted">ìµœì € ~ ìµœê³  (%)</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <small class="text-muted"><i class="fa-regular fa-clock me-1"></i>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">--:--:--</span></small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-custom p-4">
            <h5 class="fw-bold mb-4">ğŸ“Š ì˜¨/ìŠµë„ ë³€í™” ê·¸ë˜í”„</h5>
            <div class="chart-wrapper">
                <canvas id="sensorChart"></canvas>
            </div>
        </div>

        <div class="d-flex justify-content-end mt-4">
            <button id="btnComplete" class="btn btn-dark btn-lg px-5 shadow-lg">
                <i class="fa-solid fa-check-double me-2"></i>ë°°ì†¡ ì™„ë£Œ ì²˜ë¦¬
            </button>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        
        // 1. ì„œë²„ ë°ì´í„° ë°”ì¸ë”©
        const deviceId = /*[[${deviceId}]]*/ 'UNKNOWN';
        const orderId = /*[[${orderId}]]*/ 0;
        
        console.log(`ëª¨ë‹ˆí„°ë§ ì‹œì‘ - Device: ${deviceId}, Order: ${orderId}`);

        // 2. Chart.js ì„¤ì •
        const ctx = document.getElementById('sensorChart').getContext('2d');
        const sensorChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Xì¶• (ì‹œê°„)
                datasets: [
                    {
                        label: 'ì˜¨ë„ (Â°C)',
                        data: [],
                        borderColor: '#dc3545', // Red
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 3,
                        pointRadius: 3,
                        yAxisID: 'y',
                        tension: 0.3, // ë¶€ë“œëŸ¬ìš´ ê³¡ì„ 
                        fill: true
                    },
                    {
                        label: 'ìŠµë„ (%)',
                        data: [],
                        borderColor: '#0d6efd', // Blue
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        borderDash: [5, 5], // ì ì„ 
                        yAxisID: 'y1',
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false, // ì‹¤ì‹œê°„ ì„±ëŠ¥ ìµœì í™” (ì• ë‹ˆë©”ì´ì…˜ ë”)
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: { display: true },
                    y: { 
                        type: 'linear', display: true, position: 'left',
                        title: { display: true, text: 'ì˜¨ë„ (Â°C)' },
                        suggestedMin: 10, suggestedMax: 30
                    },
                    y1: { 
                        type: 'linear', display: true, position: 'right',
                        title: { display: true, text: 'ìŠµë„ (%)' },
                        grid: { drawOnChartArea: false },
                        suggestedMin: 30, suggestedMax: 80
                    }
                }
            }
        });

    
		// 3. SSE ì—°ê²° ë° ë°ì´í„° ì²˜ë¦¬
		        let eventSource = null;

		        function connectSensor() {
		            if(!deviceId || deviceId === 'UNKNOWN') return;

		            // SSE ì—°ê²°
		            eventSource = new EventSource(`/data/stream/${deviceId}`);

		            eventSource.addEventListener("newData", function(event) {
		                const d = JSON.parse(event.data);
		                
		                // (1) í˜„ì¬ ê°’ ì—…ë°ì´íŠ¸ (ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼)
		                updateValue('currTemp', d.temperature?.toFixed(1));
		                updateValue('currHumid', d.humidity);

		                // (2) í†µê³„ ê°’ ì—…ë°ì´íŠ¸
		                if(d.maxTemperature != null) document.getElementById('tempMax').innerText = d.maxTemperature.toFixed(1);
		                if(d.minTemperature != null) document.getElementById('tempMin').innerText = d.minTemperature.toFixed(1);
		                
		                if(d.maxHumidity != null) document.getElementById('humidMax').innerText = d.maxHumidity;
		                if(d.minHumidity != null) document.getElementById('humidMin').innerText = d.minHumidity;

		                // (3) ì‹œê°„ ì—…ë°ì´íŠ¸ ë° ì°¨íŠ¸ ê°±ì‹ 
		                if(d.measuredAt) {
		                    const timeOnly = d.measuredAt.split(' ')[1] || d.measuredAt;
		                    document.getElementById('lastUpdate').innerText = timeOnly;
		                    
		                    updateChart(timeOnly, d.temperature, d.humidity);
		                    
		                    // â–¼â–¼â–¼ [ì¶”ê°€ëœ ë¶€ë¶„] ì´ë²¤íŠ¸ ë¡œê·¸ ìë™ ê¸°ë¡ ë¡œì§ â–¼â–¼â–¼
		                    // ì˜ˆì‹œ: ì˜¨ë„ê°€ 10ë„ë¥¼ ë„˜ìœ¼ë©´ ê²½ê³  ë¡œê·¸ ì¶”ê°€
		                    if (d.temperature != null && d.temperature > 10.0) {
		                        addLog('ê²½ê³ ', `ì˜¨ë„ ì´íƒˆ ê°ì§€ (${d.temperature.toFixed(1)}Â°C)`, d.measuredAt);
		                    }
		                }
		            });

		            eventSource.onerror = (err) => {
		                console.error("SSE ì—°ê²° ë¶ˆì•ˆì •:", err);
		                // ì—°ê²° ëŠê¹€ ì‹œ ë¡œê·¸ì— í‘œì‹œ (ì„ íƒì‚¬í•­)
		                // addLog('ì •ë³´', 'ì„¼ì„œ ì—°ê²°ì´ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.', new Date().toLocaleString());
		            };
		        }

		        // â–¼â–¼â–¼ [í•„ìˆ˜ ì¶”ê°€] ë¡œê·¸ë¥¼ í™”ë©´(Sidebar)ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ â–¼â–¼â–¼
		        function addLog(type, msg, fullTime) {
		            const list = document.getElementById('eventLogList');
		            if(!list) return; // HTMLì— ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ íŒ¨ìŠ¤

		            const timeOnly = fullTime.split(' ')[1] || fullTime; // ì‹œê°„ë§Œ ì¶”ì¶œ

		            // ë±ƒì§€ ìƒ‰ìƒ ê²°ì •
		            let badgeClass = 'bg-secondary';
		            if (type === 'ê²½ê³ ') badgeClass = 'bg-danger';
		            if (type === 'ì •ìƒ') badgeClass = 'bg-success';

		            // li íƒœê·¸ ìƒì„±
		            const li = document.createElement('li');
		            li.className = "list-group-item d-flex justify-content-between px-0 animate__animated animate__fadeIn"; // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ í´ë˜ìŠ¤(ì„ íƒ)
		            
		            li.innerHTML = `
		                <span>
		                    <span class="badge ${badgeClass} me-2">${type}</span>${msg}
		                </span>
		                <span class="text-muted small">${timeOnly}</span>
		            `;

		            // ë¦¬ìŠ¤íŠ¸ì˜ ë§¨ ìœ„ì— ì¶”ê°€ (prepend)
		            list.prepend(li);
		            
		            // ë¡œê·¸ê°€ ë„ˆë¬´ ë§ì´ ìŒ“ì´ë©´ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ (ì˜ˆ: 20ê°œ ìœ ì§€)
		            if (list.children.length > 20) {
		                list.removeChild(list.lastChild);
		            }
		        }

        // ê°’ ì—…ë°ì´íŠ¸ ì‹œ ê¹œë¹¡ì„ íš¨ê³¼ ì£¼ëŠ” í•¨ìˆ˜
        function updateValue(elementId, value) {
            if(value == null) return;
            const el = document.getElementById(elementId);
            el.innerText = value;
            
            // í´ë˜ìŠ¤ ì œê±° í›„ ì¬ì¶”ê°€ë¡œ ì• ë‹ˆë©”ì´ì…˜ ë¦¬ì…‹
            el.classList.remove('flash');
            void el.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ (ë¸Œë¼ìš°ì €ê°€ ë³€ê²½ ì¸ì‹í•˜ê²Œ í•¨)
            el.classList.add('flash');
        }

        // ì°¨íŠ¸ ë°ì´í„° ì¶”ê°€ ë° ì´ë™ (ìµœê·¼ 20ê°œ ìœ ì§€)
        function updateChart(label, temp, humid) {
            sensorChart.data.labels.push(label);
            sensorChart.data.datasets[0].data.push(temp);
            sensorChart.data.datasets[1].data.push(humid);

            if(sensorChart.data.labels.length > 20) {
                sensorChart.data.labels.shift();
                sensorChart.data.datasets[0].data.shift();
                sensorChart.data.datasets[1].data.shift();
            }
            sensorChart.update();
        }

        // 4. ë°°ì†¡ ì™„ë£Œ ë²„íŠ¼ ë¡œì§
        document.getElementById('btnComplete').addEventListener('click', function() {
            if(!confirm("ë°°ì†¡ì„ ì™„ë£Œ ì²˜ë¦¬í•˜ê³  ëª¨ë‹ˆí„°ë§ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            // POST /api/admin/orders/{orderId}/complete
            fetch(`/api/admin/orders/${orderId}/complete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(res => {
                if(res.ok) {
                    alert("âœ… ë°°ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    if(eventSource) eventSource.close(); // SSE ì—°ê²° ëŠê¸°
                    window.close(); // ì°½ ë‹«ê¸°
                    // ë§Œì•½ íŒì—…ì´ ì•„ë‹ˆë¼ë©´ location.href = '/admin/orders';
                } else {
                    alert("ì²˜ë¦¬ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            })
            .catch(err => console.error(err));
        });

        // ì´ˆê¸° ì‹¤í–‰
        connectSensor();

        /*]]>*/
    </script>
</body>
</html>