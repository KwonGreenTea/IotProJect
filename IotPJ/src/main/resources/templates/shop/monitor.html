<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë‚´ ì„ ë¬¼ ì¶”ì  | MERRY SHOP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --xmas-red: #D42426; --xmas-green: #198754; --fresh-blue: #0dcaf0; }
        body { background-color: #f5f7fa; font-family: 'Noto Sans KR', sans-serif; -webkit-font-smoothing: antialiased; }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .status-card {
            border: none; border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            background: white; overflow: hidden; margin-bottom: 16px;
        }

        /* íˆì–´ë¡œ ì„¹ì…˜ */
        .hero-section {
            background: linear-gradient(135deg, var(--xmas-red) 0%, #ff6b6b 100%);
            color: white; padding: 30px 20px 40px; text-align: center;
            border-radius: 0 0 25px 25px; margin-bottom: -30px;
            transition: background 1s ease;
        }

        .pulse-icon { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ë°ì´í„° ë°•ìŠ¤ */
        .glass-box {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            border-radius: 16px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
        }

        /* ì°¨íŠ¸ ë†’ì´ */
        .chart-container { position: relative; height: 220px; width: 100%; }
        
        /* ë°°ì†¡ ë‹¨ê³„ */
        .step-item { text-align: center; position: relative; z-index: 1; flex: 1; }
        .step-icon {
            width: 36px; height: 36px; border-radius: 50%; background: #e9ecef; color: #adb5bd;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 8px;
            font-size: 1rem; transition: all 0.3s;
        }
        .step-item.active .step-icon { 
            background: var(--xmas-green); color: white; 
            box-shadow: 0 2px 8px rgba(25, 135, 84, 0.3); 
        }
        .step-text { font-size: 0.75rem; font-weight: bold; color: #333; }
        
        .progress-bg { 
            position: absolute; top: 18px; left: 0; width: 100%; height: 3px; 
            background-color: #e9ecef; z-index: 0; 
        }
        .progress-bar-custom {
            height: 100%; background-color: var(--xmas-green); transition: width 0.5s;
        }

        /* í…ìŠ¤íŠ¸ ê¹œë¹¡ì„ */
        .pulse-text { animation: text-flash 0.5s; }
        @keyframes text-flash { 0% { opacity: 0.3; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div class="hero-section shadow-sm" id="heroSection">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge bg-white bg-opacity-25 fw-normal px-2 py-1">Order <span th:text="|#${orderId}|">#0</span></span>
            <button onclick="window.close()" class="btn btn-sm text-white p-0"><i class="fa-solid fa-xmark fs-4"></i></button>
        </div>

        <div class="mb-3 mt-2">
            <div id="statusIconWrapper" style="height: 60px;">
                <i class="fa-solid fa-face-smile-wink fa-3x pulse-icon"></i>
            </div>
            <h3 class="fw-bold mb-1 mt-2" id="statusMessage">ì—°ê²° ì¤‘...</h3>
            <p class="small opacity-75 mb-0" id="subMessage">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        </div>

        <div class="row g-2 mt-3">
            <div class="col-6">
                <div class="glass-box">
                    <small class="d-block mb-1 opacity-75" style="font-size: 0.75rem;">í˜„ì¬ ì˜¨ë„</small>
                    <div class="fs-1 fw-bold lh-1"><span id="currTemp">--</span><span class="fs-6 fw-normal ms-1">Â°C</span></div>
                </div>
            </div>
            <div class="col-6">
                <div class="glass-box">
                    <small class="d-block mb-1 opacity-75" style="font-size: 0.75rem;">í˜„ì¬ ìŠµë„</small>
                    <div class="fs-1 fw-bold lh-1"><span id="currHumid">--</span><span class="fs-6 fw-normal ms-1">%</span></div>
                </div>
            </div>
        </div>
        
        <div class="mt-3" style="font-size: 0.7rem; opacity: 0.6;">
            <i class="fa-regular fa-clock me-1"></i>Last Update: <span id="lastUpdate">--:--:--</span>
        </div>
    </div>

    <div class="container px-3" style="margin-top: 40px;">
        
        <div class="card status-card p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold text-secondary m-0" style="font-size: 0.9rem;">ğŸšš ë°°ì†¡ ì§„í–‰</h6>
                <span class="badge bg-success bg-opacity-10 text-success rounded-pill" style="font-size: 0.7rem;">ì´ë™ ì¤‘</span>
            </div>
            <div class="position-relative mx-1">
                <div class="progress-bg">
                    <div class="progress-bar-custom" style="width: 50%"></div>
                </div>
                <div class="d-flex justify-content-between">
                    <div class="step-item active">
                        <div class="step-icon"><i class="fa-solid fa-gift"></i></div>
                        <div class="step-text">ìƒí’ˆì¤€ë¹„</div>
                    </div>
                    <div class="step-item active">
                        <div class="step-icon"><i class="fa-solid fa-truck-fast"></i></div>
                        <div class="step-text">ë°°ì†¡ì¤‘</div>
                    </div>
                    <div class="step-item">
                        <div class="step-icon"><i class="fa-solid fa-house"></i></div>
                        <div class="step-text text-muted">ë„ì°©</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card status-card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <h6 class="fw-bold text-secondary m-0" style="font-size: 0.9rem;">ğŸŒ¡ï¸ ì˜¨ë„ ë³€í™”</h6>
                </div>
                <span class="badge bg-info bg-opacity-10 text-info rounded-pill" style="font-size: 0.7rem;">
                    <i class="fa-solid fa-shield-halved me-1"></i>Fresh Care
                </span>
            </div>
            
            <div class="chart-container">
                <canvas id="userChart"></canvas>
            </div>
            
            <div class="mt-2 bg-light rounded p-2 text-center text-muted" style="font-size: 0.75rem;">
                <i class="fa-solid fa-circle-check text-success me-1"></i>
                ì‹ ì„  ì˜¨ë„(0~10Â°C)ë¥¼ ì¤€ìˆ˜ ì¤‘ì…ë‹ˆë‹¤.
            </div>
        </div>

        <div class="text-center mb-4">
            <span class="badge bg-secondary bg-opacity-10 text-secondary rounded-pill px-3 py-2 mb-2">
                <i class="fa-solid fa-cube me-1"></i>ìš´ì†¡ì¥: <span th:text="${orderInfoDTO.deliveryId != null ? orderInfoDTO.deliveryId : 'ë°œê¸‰ ì¤‘'}"></span>
            </span>
            <p class="text-muted small">MERRY SHOPì´ ì•ˆì „í•˜ê²Œ ë°°ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
            <button onclick="window.close()" class="btn btn-dark w-100 rounded-pill py-2 fw-bold">ë‹«ê¸°</button>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const deviceId = /*[[${deviceId}]]*/ 'UNKNOWN';
        const orderId = /*[[${orderId}]]*/ 0;
        
        // [ë¡œê·¸ 1] ì´ˆê¸°í™” í™•ì¸
        console.log(`[MobileMonitor] [1] Init - Device: ${deviceId}, Order: ${orderId}`);

        // ì°¨íŠ¸ ì„¤ì •
        const ctx = document.getElementById('userChart').getContext('2d');
        let gradient = ctx.createLinearGradient(0, 0, 0, 200);
        gradient.addColorStop(0, 'rgba(13, 202, 240, 0.3)'); 
        gradient.addColorStop(1, 'rgba(13, 202, 240, 0.0)'); 

        const userChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'ì˜¨ë„',
                    data: [],
                    borderColor: '#0dcaf0',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#0dcaf0',
                    pointRadius: 3,
                    fill: true,
                    tension: 0.4,
					
					showLine: true,   
					spanGaps: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { 
                        display: true,
                        suggestedMin: -2, suggestedMax: 12,
                        grid: { color: '#f0f0f0', borderDash: [5, 5] },
                        ticks: { font: { size: 10 }, callback: function(val) { return val + 'Â°'; } }
                    }
                },
                animation: false
            }
        });

        // SSE ì—°ê²°
        if(deviceId && deviceId !== 'UNKNOWN') {
            const sseUrl = `/data/stream/${deviceId}`;
            console.log(`[MobileMonitor] [2] Connecting to: ${sseUrl}`);

            const eventSource = new EventSource(sseUrl);
            
            // [ë¡œê·¸ 3] ì—°ê²° ì„±ê³µ ì‹œ
            eventSource.onopen = function() {
                console.log("[MobileMonitor] [3] SSE Connected âœ…");
            };

            eventSource.addEventListener("newData", function(event) {
                // [ë¡œê·¸ 4] ë°ì´í„° ìˆ˜ì‹ 
                console.log("[MobileMonitor] [4] Data Received:", event.data);

                try {
                    const d = JSON.parse(event.data);

                    // ê°’ ì—…ë°ì´íŠ¸
                    updateValue('currTemp', d.temperature?.toFixed(1));
                    updateValue('currHumid', d.humidity);

                    // íƒ€ì„ìŠ¤íƒ¬í”„ & ì°¨íŠ¸
                    if(d.measuredAt) {
                        const timeOnly = d.measuredAt.split(' ')[1] || d.measuredAt;
                        document.getElementById('lastUpdate').innerText = timeOnly;
                        
                        userChart.data.labels.push(timeOnly);
                        userChart.data.datasets[0].data.push(d.temperature);
                        if(userChart.data.labels.length > 20) {
                            userChart.data.labels.shift();
                            userChart.data.datasets[0].data.shift();
                        }
                        userChart.update();
                    }

                    // í…Œë§ˆ ë³€ê²½
                    updateStatusTheme(d.temperature);

                } catch (e) { 
                    console.error("[MobileMonitor] âŒ JSON Error:", e); 
                }
            });

            eventSource.onerror = (err) => {
                console.error("[MobileMonitor] âŒ Connection Error:", err);
                document.getElementById('statusMessage').innerText = "ì—°ê²° ëŠê¹€";
            };
        } else {
            console.warn("[MobileMonitor] Device ID missing");
            document.getElementById('statusMessage').innerText = "ë°°ì†¡ ì¤€ë¹„ ì¤‘";
            document.getElementById('subMessage').innerText = "ì„¼ì„œ ë°ì´í„° ëŒ€ê¸° ì¤‘";
        }

        // --- Helper Functions ---

        function updateValue(id, val) {
            if(val == null) return;
            const el = document.getElementById(id);
            if(el) {
                el.innerText = val;
                el.classList.remove('pulse-text');
                void el.offsetWidth;
                el.classList.add('pulse-text');
            }
        }

        function updateStatusTheme(temp) {
            if(temp == null) return;
            // [ë¡œê·¸ 5] í…Œë§ˆ ë³€ê²½ ì‹¤í–‰ í™•ì¸
            // console.log(`[MobileMonitor] [5] Theme Update: ${temp}Â°C`);

            const hero = document.getElementById('heroSection');
            const msg = document.getElementById('statusMessage');
            const sub = document.getElementById('subMessage');
            const iconWrap = document.getElementById('statusIconWrapper');

            if(temp > 10) {
                hero.style.background = "linear-gradient(135deg, #ff9966 0%, #ff5e62 100%)";
                msg.innerText = "ì˜¨ë„ ì£¼ì˜! ğŸŒ¡ï¸";
                sub.innerText = "ì˜¨ë„ê°€ ì¡°ê¸ˆ ë†’ì•„ìš”.";
                if(iconWrap) iconWrap.innerHTML = '<i class="fa-solid fa-face-surprise fa-3x pulse-icon"></i>';
            } else if (temp < -5) {
                hero.style.background = "linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)";
                msg.innerText = "ë„ˆë¬´ ì¶”ì›Œìš”! â„ï¸";
                sub.innerText = "ëƒ‰ë™ ìƒíƒœ ìœ ì§€ ì¤‘.";
                if(iconWrap) iconWrap.innerHTML = '<i class="fa-solid fa-snowflake fa-3x pulse-icon"></i>';
            } else {
                hero.style.background = "linear-gradient(135deg, #D42426 0%, #ff6b6b 100%)";
                msg.innerText = "ì‹ ì„  ë°°ì†¡ ì¤‘ ğŸšš";
                sub.innerText = "ì•ˆì „í•˜ê²Œ ì´ë™í•˜ê³  ìˆì–´ìš”.";
                if(iconWrap) iconWrap.innerHTML = '<i class="fa-solid fa-face-smile-wink fa-3x pulse-icon"></i>';
            }
        }
        /*]]>*/
    </script>
	
	<script th:inline="javascript">
	  const dataList = /*[[${dataDTOList}]]*/ [];

	  // ê¸°ì¡´ ë°ì´í„° ìˆìœ¼ë©´ ë¹„ìš°ê³  ë‹¤ì‹œ ì±„ì›€
	  userChart.data.labels = [];
	  userChart.data.datasets[0].data = [];

	  if (Array.isArray(dataList) && dataList.length > 0) {

	    // âœ… ì‹œê°„ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬(ê³¼ê±° -> í˜„ì¬)
	    const sorted = [...dataList].sort((a, b) => {
	      const ta = a.measuredAt ? Date.parse(a.measuredAt.replace(' ', 'T')) : -Infinity;
	      const tb = b.measuredAt ? Date.parse(b.measuredAt.replace(' ', 'T')) : -Infinity;
	      return ta - tb;
	    });

	    sorted.forEach(d => {
	      const temp = Number(d.temperature);
	      if (!Number.isFinite(temp)) return;

	      const label =
	        (d.measuredAt ? (d.measuredAt.split(' ')[1] || d.measuredAt)
	                      : (d.regDate || ''));
	      if (!label) return;

	      userChart.data.labels.push(label);
	      userChart.data.datasets[0].data.push(temp);
	    });

	    // ìµœê·¼ 20ê°œë§Œ ìœ ì§€
	    const start = Math.max(0, userChart.data.labels.length - 20);
	    userChart.data.labels = userChart.data.labels.slice(start);
	    userChart.data.datasets[0].data = userChart.data.datasets[0].data.slice(start);

	    // âœ… lastë„ ì •ë ¬ëœ ê¸°ì¤€ìœ¼ë¡œ
	    const last = sorted[sorted.length - 1];
	    const lastTemp = Number(last.temperature);

	    if (Number.isFinite(lastTemp)) {
	      updateValue('currTemp', lastTemp.toFixed(1));
	      updateValue('currHumid', last.humidity);
	      updateStatusTheme(lastTemp);

	      const lastLabel =
	        (last.measuredAt ? (last.measuredAt.split(' ')[1] || last.measuredAt)
	                         : (last.regDate || ''));
	      if (lastLabel) document.getElementById('lastUpdate').innerText = lastLabel;
	    }

	    userChart.update();
	  }
	</script>

</body>
</html>